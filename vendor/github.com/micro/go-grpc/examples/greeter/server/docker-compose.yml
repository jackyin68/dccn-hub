version: '3.1'

services:
    consul:
        command: -server -bootstrap -rejoin 
        image: progrium/consul:latest
        hostname: "registry"
        ports:
            - "8300:8300"
            - "8400:8400"
            - "8500:8500"
            - "8600:53/udp"
    micro:
        image: microhq/micro:latest
        # command: micro --enable_stats --registry_address=registry:8500 --register_interval=5 --register_ttl=10 api
        command: --registry_address=consul:8500 api --handler=rpc
        build: .
        links:
            - consul
        ports:
            - "8080:8080"

    proxy:
        command: --registry_address=registry:8500 --register_interval=5 --register_ttl=10 proxy
        build: .
        links:
            - consul
        ports:
            - "8081:8081"

    web:
        command: --registry_address=registry:8500 --register_interval=5 --register_ttl=10 web
        build: .
        links:
            - consul
        ports:
            - "8082:8082"

    greeter:
        build: .
        depends_on:
            - api
